
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>FX取引分析ツール - 安定版</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
/* =========================
 * THEME TOKENS（全体の色/余白）
 * ========================= */
:root{
  /* surfaces */
  --bg-primary:#010e21;   /* ページ地/ヘッダー/メイン */
  --bg-panel:#0c1a2b;     /* セクション容器（外枠） */
  --bg-card:#010e21;      /* 小カード（直近改善度の内側など） */

  /* borders / radius / space */
  --border-color:#525960;
  --card-border:#393c3f;
  --radius-lg:12px;
  --space:20px;
  --title-gap:16px;

  /* text */
  --text-main:#C9D0D6;
  --text-heading:#DCE2E7;
  --text-sub:#A7AFB7;

  /* accents */
  --positive-color:#00c8ff;
  --negative-color:#E35B5B;
  --neutral-color:#6b7280;

  /* charts */
  --chart-grid-color:rgba(255,255,255,.2);
  --chart-text-color:#A7AFB7;
}

/* Light theme overrides */
html.light{
  --bg-primary:#f6f7fb;
  --bg-panel:#f3f4f6;
  --bg-card:#ffffff;

  --border-color:#afafaf;
  --card-border:#c4c4c4;

  --text-main:#111827;
  --text-heading:#0F172A;
  --text-sub:#475569;

  --positive-color:#0A6CFF;
  --negative-color:#E35B5B;
  --neutral-color:#334155;

  --chart-grid-color:#E5E7EB;
  --chart-text-color:#334155;
}

/* ロゴの出し分け */
.logo .logo-dark{display:block;}
.logo .logo-light{display:none;}
html.light .logo .logo-dark{display:none;}
html.light .logo .logo-light{display:block;}

/* =========================
 * RESET / BASE
 * ========================= */
*{margin:0;padding:0;box-sizing:border-box;}
body{
  font-family:'Segoe UI','Hiragino Sans','Yu Gothic UI',system-ui,sans-serif;
  background:var(--bg-primary);
  color:var(--text-main);
  min-height:100vh;
  transition:background .3s,color .3s;
}

/* =========================
 * HEADER（フィルター行）
 * ========================= */
.filters-header{
  padding:12px 20px;
  background:var(--bg-primary);
  border-bottom:1px solid var(--border-color);
  display:flex;align-items:center;gap:16px;justify-content:flex-start;
}
.logo{cursor:pointer;}
.logo img{display:block;width:100px;height:auto;}

.filters-grid{flex:1;display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
.filter-select{
  background:var(--bg-panel);
  border:1px solid var(--border-color);
  border-radius:4px;
  color:var(--text-main);
  font-size:12px;
  padding:6px 10px;
  height:32px;
  width:160px;max-width:160px;
  transition:.2s;
}
.filter-select:focus{outline:none;border-color:var(--positive-color);}
.filter-select:hover{border-color:var(--text-sub);}
.filter-select option{background:var(--bg-panel);color:var(--text-main);}

.filter-actions{display:flex;gap:8px;justify-content:flex-end;align-items:center;}
.filter-btn{
  display:inline-flex;align-items:center;justify-content:center;
  min-height:32px;padding:6px 12px;border:none;border-radius:4px;
  background:linear-gradient(90deg,#0099dd,#0a6cff);color:#fff;
  font-size:12px;font-weight:600;cursor:pointer;transition:.2s;
}
.filter-btn:hover{opacity:.9;transform:translateY(-1px);}
.filter-btn.secondary{
  background:transparent;color:var(--text-sub);
  border:1px dashed var(--border-color);font-weight:500;
}
.filter-btn.secondary:hover{color:var(--text-main);border-style:solid;}

.header-right{margin-left:auto;display:flex;align-items:center;}
.theme-toggle{
  width:54px;height:32px;border-radius:16px;
  background:var(--bg-panel);
  border:1px solid var(--border-color);
  display:flex;align-items:center;cursor:pointer;padding:0 2px;
}
.theme-toggle .toggle-thumb{
  width:28px;height:28px;border-radius:50%;
  background:#fff;color:#111;display:flex;align-items:center;justify-content:center;
  transition:transform .25s ease;
}
html.light .theme-toggle{background:#d9d9d9;}
html.light .theme-toggle .toggle-thumb{transform:translateX(22px);}

/* =========================
 * LAYOUT（左カラム／メイン面）
 * ========================= */
.app-layout{display:flex;align-items:flex-start;gap:16px;margin:16px;}
.sidebar{
  width:220px;flex:0 0 220px;display:flex;flex-direction:column;gap:16px;
  background:transparent;
  border:none;  
  border-radius:12px;
}
.sidebar-top{display:flex;flex-direction:column;gap:12px;}
.upload-wrapper{position:relative;}
.upload-btn{
  display:inline-flex;align-items:center;justify-content:center;min-height:32px;
  background:linear-gradient(90deg,#0099dd,#0a6cff);color:#fff;border:none;border-radius:4px;
  font-size:13px;font-weight:600;padding:6px 12px;cursor:pointer;transition:.2s;
}
.upload-btn:hover{opacity:.9;transform:translateY(-1px);}
.file-input{display:none;}
.file-info{
  position:absolute;top:100%;left:0;
  background:var(--bg-panel);border:1px solid var(--border-color);border-radius:4px;
  padding:6px 10px;font-size:11px;color:var(--text-sub);margin-top:5px;white-space:nowrap;z-index:10;
}

.demo-section{display:flex;align-items:center;gap:6px;}
.demo-label{font-size:12px;color:var(--text-sub);}
.demo-buttons{display:flex;gap:6px;}
.demo-btn{
  background:var(--bg-panel);color:var(--text-main);
  border:1px solid var(--border-color);border-radius:4px;
  font-size:12px;font-weight:600;width:26px;height:26px;
  display:flex;align-items:center;justify-content:center;cursor:pointer;transition:.2s;
}
.demo-btn:hover{background:var(--bg-primary);border-color:var(--text-sub);}
.demo-btn.active{background:var(--positive-color);border-color:var(--positive-color);color:#fff;}

.menu{display:flex;flex-direction:column;align-items:flex-start;}
.menu-item{padding:10px 0;font-size:14px;color:var(--text-sub);cursor:pointer;transition:.15s;}
.menu-item:hover{color:var(--text-main);}
.menu-item.active{color:#fff;font-weight:700;}
.menu-separator{border-top:1px solid var(--border-color);margin:8px 0;width:100%;}
/* Light：選択中は黒＆太字 */
html.light .menu-item.active{color:var(--text-heading);font-weight:700;}

.main-area{
  flex:1;min-height:400px;display:flex;align-items:flex-start;justify-content:flex-start;
  padding:20px;color:var(--text-sub);
  background:var(--bg-primary);
  border:none;border-radius:8px;
}

@media (max-width:960px){
  .app-layout{flex-direction:column;}
  .sidebar{width:100%;flex-direction:row;overflow:auto;}
  .sidebar-top{flex-direction:row;}
  .menu{flex-direction:row;flex-wrap:wrap;}
}

/* =========================
 * TRADE APP（カード/パネル/タイポ）
 * ========================= */
.trade-app{padding:20px;color:var(--text-main);width:100%;}

/* 見出し（KPI/直近改善度/詳細分布 すべて統一） */
.trade-app .section-title{
  font-size:1rem;
  font-weight:700;
  margin:0 0 var(--title-gap);
  color:var(--text-heading);
}

/* KPIカード＝パネル色で統一（影なし） */
.trade-app .metric-card{
  background:var(--bg-panel);
  border:1px solid var(--border-color);
  border-radius:var(--radius-lg);
  box-shadow:none;
  padding:var(--space);
}
.trade-app .metric-card-header{
  display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;
}

/* 直近改善度/統計/チャートの容器（外枠） */
.trade-app .recent-delta-section,
.trade-app .stats-section,
.trade-app .chart-container{
  background:var(--bg-panel);
  border:1px solid var(--border-color);
  border-radius:var(--radius-lg);
  box-shadow:none;
  padding:var(--space);
  margin:24px 0;
}

/* 直近改善度の内側カード（小カード＝濃いめ） */
.trade-app .delta-card,
.trade-app .stats-card{
  background:var(--bg-card);
  border:1px solid var(--card-border);
  border-radius:var(--radius-lg);
  box-shadow:none;
  padding:var(--space);
  min-height:320px;
  display:flex;flex-direction:column;
}
.trade-app .delta-card-header{
  display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;
}
.trade-app .delta-value{font-size:2.1em;font-weight:800;margin:10px 0 14px;}

.trade-app .sparkline-container{
  height:150px;background:var(--bg-panel);border-radius:8px;padding:14px;
  display:flex;align-items:center;justify-content:center;
}

/* テキスト色のルール */
.trade-app .metric-subtitle{font-size:.9em;color:var(--text-sub);margin-top:6px;}
.trade-app .positive{color:var(--positive-color);}
.trade-app .negative{color:var(--negative-color);}
.trade-app .neutral{color:var(--neutral-color);}

/* 数字の見た目（桁揃え & 強調） */
.trade-app .metric-value,
.trade-app .delta-value{
  display:flex;align-items:baseline;gap:6px;
  font-variant-numeric:tabular-nums lining-nums;
  font-feature-settings:'tnum' 1,'lnum' 1;
}
.trade-app .metric-value .num,
.trade-app .delta-value .num{
  font-size:clamp(24px,3vw,32px);
  font-weight:700;letter-spacing:.02em;color:var(--text-heading);
}
.trade-app .metric-value .unit,
.trade-app .delta-value .unit{font-size:12px;color:var(--text-sub);font-weight:600;}

/* 正負/ニュートラルの色 */
.trade-app .metric-value.positive .num,
.trade-app .delta-value.positive .num{color:var(--positive-color);}
.trade-app .metric-value.negative .num,
.trade-app .delta-value.negative .num{color:var(--negative-color);}
.trade-app .metric-value.neutral .num,
.trade-app .delta-value.neutral .num{color:var(--neutral-color);}
html.light .trade-app .metric-value.neutral .num,
html.light .trade-app .delta-value.neutral .num{color:var(--text-heading);}

/* 勝ち負け統計 2カラム */
.trade-app .stats-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:24px;}
@media (max-width:860px){.trade-app .stats-grid{grid-template-columns:1fr;}}
.trade-app .stats-row{display:flex;justify-content:space-between;margin-bottom:8px;}

/* カードの影・変形は完全OFF（ブラー保険） */
.trade-app .metric-card,
.trade-app .delta-card,
.trade-app .stats-card,
.trade-app .recent-delta-section,
.trade-app .chart-container{box-shadow:none !important;transform:none !important;}

/* =========================
 * GRID（KPIや小カードの並び）
 * ========================= */
.trade-app .analysis-section{
  display:grid;gap:20px;
  grid-template-columns:repeat(auto-fit,minmax(280px,1fr));
}

/* =========================
 * HELP アイコン
 * ========================= */
.trade-app .help-icon{
  width:20px;height:20px;border-radius:50%;
  background:var(--bg-panel);border:1px solid var(--border-color);
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;color:var(--text-sub);font-size:12px;font-weight:700;
  transition:background-color .2s,color .2s;
}
.trade-app .help-icon:hover{background:var(--border-color);color:var(--text-main);}

/* =========================
 * CHART area
 * ========================= */
.trade-app .chart-canvas-container{position:relative;height:400px;width:100%;overflow:hidden;}
.trade-app canvas{max-width:100%;max-height:400px !important;}

/* =========================
 * SCROLLBAR (.trade-app 内のみ)
 * ========================= */
.trade-app ::-webkit-scrollbar{width:8px;height:8px}
.trade-app ::-webkit-scrollbar-track{background:var(--bg-panel)}
.trade-app ::-webkit-scrollbar-thumb{background:var(--border-color);border-radius:4px}
.trade-app ::-webkit-scrollbar-thumb:hover{background:var(--text-sub)}
</style>

</head>

<body>
  <!-- ここから下は“既存のHTML/JS”をそのままお使いください（機能変更なし） -->
  <!-- ……（あなたの現行HTML本体とスクリプトを残す） …… -->
</body>
</html>

  <div id="demoBadge" hidden>DEMO</div>

  <!-- ▼ ロゴ＋フィルター -->
  <div class="filters-header">
    <div class="logo">
  <img class="logo-dark"  src="https://lens1208.github.io/assets-logo-/algo-logo-web-b.png" alt="AlgoStream Logo" />
  <img class="logo-light" src="https://lens1208.github.io/assets-logo-/algo-logo-web-w.png" alt="AlgoStream Logo" />
</div>
    <div class="filters-grid">
      <select class="filter-select" id="currencyFilter">
        <option value="all">通貨ペア</option>
        <optgroup label="メジャーペア">
          <option value="USDJPY">USD/JPY</option><option value="EURUSD">EUR/USD</option>
          <option value="GBPUSD">GBP/USD</option><option value="USDCHF">USD/CHF</option>
          <option value="AUDUSD">AUD/USD</option><option value="NZDUSD">NZD/USD</option>
          <option value="USDCAD">USD/CAD</option>
        </optgroup>
        <optgroup label="クロス円">
          <option value="EURJPY">EUR/JPY</option><option value="GBPJPY">GBP/JPY</option>
          <option value="AUDJPY">AUD/JPY</option><option value="CHFJPY">CHF/JPY</option>
          <option value="CADJPY">CAD/JPY</option><option value="NZDJPY">NZD/JPY</option>
        </optgroup>
        <optgroup label="その他">
          <option value="EURGBP">EUR/GBP</option><option value="EURAUD">EUR/AUD</option>
          <option value="GBPAUD">GBP/AUD</option><option value="AUDNZD">AUD/NZD</option>
        </optgroup>
      </select>

      <select class="filter-select" id="timeFilter">
        <option value="all">時間帯</option>
        <option value="asia">アジア時間 (5:00-15:59)</option>
        <option value="london">ロンドン時間 (16:00-21:59)</option>
        <option value="ny">NY時間 (22:00-1:59)</option>
        <option value="quiet">閑散時間 (2:00-4:59)</option>
      </select>

      <select class="filter-select" id="dayFilter">
        <option value="all">曜日</option>
        <option value="weekdays">平日のみ</option>
        <option value="weekend">週末のみ</option>
        <optgroup label="個別選択">
          <option value="monday">月曜日</option><option value="tuesday">火曜日</option>
          <option value="wednesday">水曜日</option><option value="thursday">木曜日</option>
          <option value="friday">金曜日</option><option value="saturday">土曜日</option>
          <option value="sunday">日曜日</option>
        </optgroup>
      </select>

      <select class="filter-select" id="dateRange">
        <option value="today">期間</option>
        <option value="yesterday">昨日</option>
        <option value="7days">直近7日</option>
        <option value="30days">直近30日</option>
        <option value="thisMonth">今月</option>
        <option value="lastMonth">先月</option>
        <option value="12months">直近12ヶ月</option>
        <option value="lastYear">昨年</option>
        <option value="thisYear">今年</option>
      </select>

      <select class="filter-select" id="positionFilter">
        <option value="all">ポジション</option>
        <option value="long">ロング（買い）のみ</option>
        <option value="short">ショート（売り）のみ</option>
      </select>

      <select class="filter-select" id="performanceFilter">
        <option value="all">損益</option>
        <option value="profit">利益取引のみ</option>
        <option value="loss">損失取引のみ</option>
      </select>

      <div class="filter-actions">
        <button class="filter-btn" id="applyFilters">フィルター適用</button>
        <button class="filter-btn secondary" id="resetFilters">リセット</button>
      </div>
    </div>
    <div class="header-right">
      <div class="theme-toggle" id="themeToggle" role="button" aria-label="テーマ切替" tabindex="0">
        <div class="toggle-thumb" id="toggleThumb" aria-hidden="true"></div>
      </div>
    </div>
  </div>

  <!-- ▼ メインレイアウト -->
  <main class="app-layout">
    <aside class="sidebar">
      <div class="sidebar-top">
        <div class="upload-wrapper">
          <input type="file" id="fileInput" class="file-input" accept=".csv,.json" />
          <button class="upload-btn" onclick="document.getElementById('fileInput').click()">取引ファイルをアップロード</button>
          <div class="file-info" id="fileInfo" style="display:none;">ファイルが選択されていません</div>
        </div>
        <div class="demo-section">
          <span class="demo-label">デモデータ</span>
          <div class="demo-buttons">
            <button class="demo-btn" id="demoA" data-trader="excellent">A</button>
            <button class="demo-btn" id="demoB" data-trader="average">B</button>
            <button class="demo-btn" id="demoC" data-trader="poor">C</button>
          </div>
        </div>
      </div>

      <nav class="menu" id="sideMenu">
        <div class="menu-separator"></div>
        <div class="menu-item active" data-section="overview">パフォーマンス概要</div>
        <div class="menu-item" data-section="style-diagnosis">トレードスタイル診断</div>
        <div class="menu-item" data-section="risk-stability">リスクと安定性の評価</div>
        <div class="menu-item" data-section="segment-trends">セグメント別傾向分析</div>
        <div class="menu-item" data-section="exit-quality">利確と損切りの品質</div>
        <div class="menu-item" data-section="score-ai">総合スコア &amp; AI分析</div>
        <div class="menu-separator"></div>
        <div class="menu-item" data-section="coaching-share">コーチング &amp; シェア</div>
        <div class="menu-item" data-section="tools-settings">ツール設定</div>
        <div class="menu-item" data-section="mydata">マイデータ管理</div>
        <div class="menu-item" data-section="support">設定 &amp; サポート</div>
      </nav>
    </aside>
    
<section class="main-area" id="contentArea">
  <div id="overviewRoot" class="trade-app">
    <div style="text-align:center; padding:40px; color:var(--text-sub, #aaa);">
      読み込み中…
    </div>
  </div>
</section>

  </main>

  <script>
  // ===== Util =====
  function dispatch(name, detail){ document.dispatchEvent(new CustomEvent(name, { detail })); }

  // ===== Filters =====
  function getFilterValues(){
    return {
      currency: document.getElementById('currencyFilter').value,
      time: document.getElementById('timeFilter').value,
      day: document.getElementById('dayFilter').value,
      dateRange: document.getElementById('dateRange').value,
      position: document.getElementById('positionFilter').value,
      performance: document.getElementById('performanceFilter').value,
    };
  }
  function resetAllFilters(){
    document.getElementById('currencyFilter').value='all';
    document.getElementById('timeFilter').value='all';
    document.getElementById('dayFilter').value='all';
    document.getElementById('dateRange').value='today';
    document.getElementById('positionFilter').value='all';
    document.getElementById('performanceFilter').value='all';
  }
  function initFilters(){
    ['currencyFilter','timeFilter','dayFilter','dateRange','positionFilter','performanceFilter']
      .forEach(id=>{ const el=document.getElementById(id); if(el) el.addEventListener('change',()=>dispatch('filtersChanged', getFilterValues())); });
    const apply=document.getElementById('applyFilters');
    const reset=document.getElementById('resetFilters');
    if(apply) apply.addEventListener('click',()=>dispatch('filtersChanged', getFilterValues()));
    if(reset) reset.addEventListener('click',()=>{ resetAllFilters(); dispatch('filtersChanged', getFilterValues()); });
  }

  // ===== Side Menu =====
  function initSideMenu(){
    const items=document.querySelectorAll('#sideMenu .menu-item');
    items.forEach(item=>{
      item.addEventListener('click',()=>{
        items.forEach(t=>t.classList.remove('active'));
        item.classList.add('active');
        dispatch('tabChanged',{ section:item.dataset.section });
      });
    });
  }

  // ===== Upload & Demo =====
  function initUploadAndDemo(){
    const input=document.getElementById('fileInput');
    const info=document.getElementById('fileInfo');
    if(input){
      input.addEventListener('change',(ev)=>{
        const file=ev.target.files[0]; if(!file) return;
        if(info){ info.style.display='block'; info.textContent=`${file.name} (${(file.size/1024).toFixed(1)} KB)`; }
        dispatch('fileUploaded', file);
      });
    }
    document.querySelectorAll('.demo-btn').forEach(btn=>{
      btn.addEventListener('click',()=>{
        document.querySelectorAll('.demo-btn').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        dispatch('demoChanged', { trader: btn.dataset.trader || 'excellent' });
      });
    });
  }

  // ===== Theme Toggle =====
  function initThemeToggle(){
    const btn=document.getElementById('themeToggle');
    const thumb=document.getElementById('toggleThumb');
    const ICONS={
      sun:'<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M12 4a1 1 0 0 1 1 1v2a1 1 0 1 1-2 0V5a1 1 0 0 1 1-1zm0 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8zm7-5a1 1 0 0 1 1 1h2a1 1 0 1 1 0 2h-2a1 1 0 1 1-1-1zm-16 0a1 1 0 0 1-1 1H1a1 1 0 1 1 0-2h2a1 1 0 0 1 1 1zm12.95 6.364a1 1 0 0 1 1.414 0l1.272 1.272a1 1 0 1 1-1.414 1.414l-1.272-1.272a1 1 0 0 1 0-1.414zM4.364 5.636a1 1 0 0 1 1.414 0L7.05 6.909A1 1 0 1 1 5.636 8.323L4.364 7.05a1 1 0 0 1 0-1.414zm11.272-2.272a1 1 0 0 1 1.414 1.414L15.778 6.05A1 1 0 0 1 14.364 4.636l1.272-1.272zM6.222 17.95a1 1 0 0 1 0 1.414L4.95 20.636a1 1 0 1 1-1.414-1.414l1.272-1.272a1 1 0 0 1 1.414 0z"/></svg>',
      moon:'<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M21 12.79A9 9 0 1 1 11.21 3a7 7 0 0 0 9.79 9.79z"/></svg>'
    };
    function apply(mode){
      const root=document.documentElement;
      if(mode==='light'){ root.classList.add('light'); thumb.innerHTML=ICONS.sun; }
      else { root.classList.remove('light'); thumb.innerHTML=ICONS.moon; }
      try{ localStorage.setItem('theme', mode==='light'?'light':'dark'); }catch(e){}
    }
    let mode='dark';
    try{ const saved=localStorage.getItem('theme'); if(saved==='light'){ mode='light'; } }catch(e){}
    apply(mode);
    btn.addEventListener('click',()=>{
      mode=document.documentElement.classList.contains('light')?'dark':'light';
      apply(mode);
    });
    btn.addEventListener('keydown',(e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); btn.click(); }});
  }

  // ===== Logo =====
  function initLogo(){
    const lg=document.querySelector('.logo');
    if(lg){ lg.addEventListener('click',()=>window.scrollTo({top:0,behavior:'smooth'})); }
  }

  // ===== Init =====
  window.addEventListener('DOMContentLoaded',()=>{
    initThemeToggle();
    initFilters();
    initSideMenu();
    initUploadAndDemo();
    initLogo();
    dispatch('filtersChanged', getFilterValues());
  });
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

<script>
/* ===== パフォーマンス概要：コンテンツ統合JS（イベント購読のみ） ===== */
let currentData = null;
let activeCharts = [];

const dataSets = {
  excellent:{ name:"優秀なトレーダー",
    kpi:{ totalTrades:150, winRate:75.2, totalProfit:320000, avgProfit:12800, avgLoss:-4200, avgHoldingTime:"2時間15分", expectedValue:2133, profitFactor:3.05 },
    performance_delta:{ profitFactor:0.25, expectedValue:1200, winRate:-2.1 },
    pareto:{ top:[45000,38000,32000,28000,25000], bottom:[-8000,-6500,-5200,-4800,-4100] },
    charts:{ cumulative:[], distribution:[
      {range:"5万円以上",count:3,color:"positive"},{range:"3万～5万円",count:8,color:"positive"},
      {range:"2万～3万円",count:12,color:"positive"},{range:"1万～2万円",count:18,color:"positive"},
      {range:"5千～1万円",count:25,color:"positive"},{range:"0～5千円",count:21,color:"neutral"},
      {range:"-5千円～0円",count:15,color:"neutral"},{range:"-1万～-5千円",count:20,color:"negative"},
      {range:"-2万～-1万円",count:18,color:"negative"},{range:"-3万～-2万円",count:8,color:"negative"},
      {range:"-5万～-3万円",count:2,color:"negative"} ]} },
  average:{ name:"平均的なトレーダー",
    kpi:{ totalTrades:120, winRate:55.8, totalProfit:45000, avgProfit:8500, avgLoss:-6200, avgHoldingTime:"3時間45分", expectedValue:375, profitFactor:1.18 },
    performance_delta:{ profitFactor:-0.15, expectedValue:-800, winRate:1.8 },
    pareto:{ top:[25000,18000,15000,12000,10500], bottom:[-15000,-12000,-9500,-8200,-7100] },
    charts:{ cumulative:[], distribution:[
      {range:"3万円以上",count:2,color:"positive"},{range:"2万～3万円",count:5,color:"positive"},
      {range:"1万～2万円",count:12,color:"positive"},{range:"5千～1万円",count:18,color:"positive"},
      {range:"0～5千円",count:30,color:"neutral"},{range:"-5千円～0円",count:25,color:"neutral"},
      {range:"-1万～-5千円",count:16,color:"negative"},{range:"-2万～-1万円",count:8,color:"negative"},
      {range:"-3万～-2万円",count:3,color:"negative"},{range:"-3万円以下",count:1,color:"negative"} ]} },
  poor:{ name:"改善必要なトレーダー",
    kpi:{ totalTrades:95, winRate:38.9, totalProfit:-85000, avgProfit:6200, avgLoss:-8900, avgHoldingTime:"5時間20分", expectedValue:-895, profitFactor:0.65 },
    performance_delta:{ profitFactor:-0.45, expectedValue:-2100, winRate:-8.3 },
    pareto:{ top:[18000,12000,9500,8200,7100], bottom:[-25000,-18000,-15000,-12000,-10500] },
    charts:{ cumulative:[], distribution:[
      {range:"2万円以上",count:1,color:"positive"},{range:"1万～2万円",count:4,color:"positive"},
      {range:"5千～1万円",count:8,color:"positive"},{range:"0～5千円",count:24,color:"neutral"},
      {range:"-5千円～0円",count:18,color:"neutral"},{range:"-1万～-5千円",count:20,color:"negative"},
      {range:"-2万～-1万円",count:12,color:"negative"},{range:"-3万～-2万円",count:6,color:"negative"},
      {range:"-3万円以下",count:2,color:"negative"} ]} }
};

function generateRealisticCumulativeCurve(tradeCount, finalProfit, winRate){
  const result=[0]; let p=0;
  for(let i=1;i<tradeCount;i++){
    const win=Math.random()<winRate;
    if(win){ const a = finalProfit>0 ? Math.abs(finalProfit)/(tradeCount*winRate)*1.2 : 8000+Math.random()*12000; p += a*(0.7+Math.random()*0.6); }
    else   { const b = finalProfit>0 ? Math.abs(finalProfit)/(tradeCount*(1-winRate))*0.8 : 4000+Math.random()*8000; p -= b*(0.7+Math.random()*0.6); }
    result.push(Math.round(p));
  }
  const adj=finalProfit-result[result.length-1]; const start=Math.floor(tradeCount*.7); const per=adj/Math.max(1,(tradeCount-start));
  for(let i=start;i<tradeCount;i++) result[i]+=Math.round(per*(i-start));
  return result;
}
function generateSparklineData(v){ const n=12, out=[]; const t=v>0?1:v<0?-1:0; for(let i=0;i<n;i++){ const x=i/(n-1); out.push(t*x*Math.abs(v)*0.5 + (Math.random()-0.5)*Math.abs(v)*0.3);} return out; }
function drawSparkline(id,data,color){
  const el=document.getElementById(id); if(!el||!data.length) return;
  const w=240,h=120,p=15,min=Math.min(...data),max=Math.max(...data),r=max-min||1;
  let d=''; for(let i=0;i<data.length;i++){ const x=p+(i/(data.length-1))*(w-2*p), y=h-p-((data[i]-min)/r)*(h-2*p); d+= i===0?`M ${x} ${y}`:` L ${x} ${y}`;}
  const f=data[0].toFixed(2), l=data[data.length-1].toFixed(2), up=data[data.length-1]>data[0];
  el.innerHTML=`<svg width="100%" height="100%" viewBox="0 0 ${w} ${h}">
    <path d="${d}" stroke="${color}" stroke-width="3.5" fill="none" opacity=".9"/>
    <text x="20" y="20" fill="${color}" font-size="11" opacity=".8" font-weight="600">${f}</text>
    <text x="${w-50}" y="20" fill="${color}" font-size="11" opacity=".8" font-weight="600">${l}</text>
    <text x="${w/2}" y="${h-10}" fill="${color}" font-size="10" opacity=".7" text-anchor="middle" font-weight="600">${up?'改善傾向':'悪化傾向'}</text>
  </svg>`;
}

function csVar(name, fallback){
  const v = getComputedStyle(document.documentElement).getPropertyValue(name).trim();
  return v || fallback;
}

function renderAnalysis(){
  activeCharts.forEach(c=>{try{c.destroy()}catch(e){} });
  activeCharts=[];

  const root=document.getElementById('overviewRoot');
  if(!currentData){
    root.innerHTML='<div style="text-align:center; padding:60px 20px; color:var(--text-sub, #aaa);"><h3 class="section-title" style="margin-bottom:12px">データを選択してください</h3><p>ヘッダー／サイドの操作でデータを切替できます</p></div>';
    return;
  }
  const d=currentData;
  if(!d.charts.cumulative.length){
    d.charts.cumulative = generateRealisticCumulativeCurve(d.kpi.totalTrades, d.kpi.totalProfit, d.kpi.winRate/100);
  }
  const win=Math.round(d.kpi.totalTrades*d.kpi.winRate/100);
  const lose=d.kpi.totalTrades-win;

  root.innerHTML = `
    <div class="analysis-section" id="kpiSection"></div>
    <div id="deltaSection"></div>
    <div id="detailsSection"></div>
    <div id="chartsSection"></div>
  `;

  const card=(t,v,c='',s='')=>`<div class="metric-card"><div class="metric-card-header"><h3>${t}</h3></div><div class="metric-value ${c}">${v}</div><div class="metric-subtitle">${s}</div></div>`;
  
const k=document.getElementById('kpiSection');
k.innerHTML = [
  `<div class="metric-card">
     <div class="metric-card-header"><h3>総取引数</h3><div class="help-icon" onclick="showHelp('totalTrades')">?</div></div>
     <div class="metric-value">`+d.kpi.totalTrades+`回</div>
     <div class="metric-subtitle">分析対象取引数</div>
   </div>`,
  `<div class="metric-card">
     <div class="metric-card-header"><h3>勝率</h3><div class="help-icon" onclick="showHelp('winRate')">?</div></div>
     <div class="metric-value `+(d.kpi.winRate>=50?'positive':'negative')+`">`+d.kpi.winRate.toFixed(1)+`%</div>
     <div class="metric-subtitle">勝ち:`+win+`回 / 負け:`+lose+`回</div>
   </div>`,
  `<div class="metric-card">
     <div class="metric-card-header"><h3>総収益</h3><div class="help-icon" onclick="showHelp('totalProfit')">?</div></div>
     <div class="metric-value `+(d.kpi.totalProfit>=0?'positive':'negative')+`">`+Math.round(d.kpi.totalProfit).toLocaleString()+`円</div>
     <div class="metric-subtitle">全取引の合計収益</div>
   </div>`,
  `<div class="metric-card">
     <div class="metric-card-header"><h3>平均利益</h3><div class="help-icon" onclick="showHelp('avgProfit')">?</div></div>
     <div class="metric-value positive">`+Math.round(d.kpi.avgProfit).toLocaleString()+`円</div>
     <div class="metric-subtitle">勝ちトレード平均</div>
   </div>`,
  `<div class="metric-card">
     <div class="metric-card-header"><h3>平均損失</h3><div class="help-icon" onclick="showHelp('avgLoss')">?</div></div>
     <div class="metric-value negative">`+Math.round(Math.abs(d.kpi.avgLoss)).toLocaleString()+`円</div>
     <div class="metric-subtitle">負けトレード平均</div>
   </div>`,
  `<div class="metric-card">
     <div class="metric-card-header"><h3>平均保有時間</h3><div class="help-icon" onclick="showHelp('avgHoldingTime')">?</div></div>
     <div class="metric-value neutral">`+d.kpi.avgHoldingTime+`</div>
     <div class="metric-subtitle">ポジション保有時間</div>
   </div>`,
  `<div class="metric-card">
     <div class="metric-card-header"><h3>期待値</h3><div class="help-icon" onclick="showHelp('expectedValue')">?</div></div>
     <div class="metric-value `+(d.kpi.expectedValue>=0?'positive':'negative')+`">`+Math.round(d.kpi.expectedValue).toLocaleString()+`円/件</div>
     <div class="metric-subtitle">1取引あたりの平均期待収益</div>
   </div>`,
  `<div class="metric-card">
     <div class="metric-card-header"><h3>プロフィットファクター</h3><div class="help-icon" onclick="showHelp('profitFactor')">?</div></div>
     <div class="metric-value `+(d.kpi.profitFactor>=1?'positive':'negative')+`">`+d.kpi.profitFactor.toFixed(2)+`</div>
     <div class="metric-subtitle">総利益 ÷ 総損失</div>
   </div>`
].join('');


  if(d.performance_delta){
    const x=d.performance_delta, cls=v=>v>0?'positive':v<0?'negative':'neutral', sign=v=>v>=0?'+':'';
    document.getElementById('deltaSection').innerHTML = `
      <div class="recent-delta-section">
        <h3 class="section-title">直近改善度</h3>
        <div class="analysis-section">
          <div class="delta-card" onclick="showDeltaDetail('profitFactor')">
            <div class="delta-card-header">
              <h4>PF Δ</h4>
              <div class="help-icon" onclick="showHelp('pf'); event.stopPropagation(); return false;">?</div>
            </div>
            <div class="delta-value ${cls(x.profitFactor)}">${sign(x.profitFactor)}${x.profitFactor.toFixed(2)}</div>
            <div class="sparkline-container"><div id="sparkline-pf"></div></div>
          </div>
          <div class="delta-card" onclick="showDeltaDetail('expectedValue')">
            <div class="delta-card-header">
              <h4>EV Δ（円/件）</h4>
              <div class="help-icon" onclick="showHelp('ev'); event.stopPropagation(); return false;">?</div>
            </div>
            <div class="delta-value ${cls(x.expectedValue)}">${sign(x.expectedValue)}${Math.round(Math.abs(x.expectedValue)).toLocaleString()}円</div>
            <div class="sparkline-container"><div id="sparkline-ev"></div></div>
          </div>
          <div class="delta-card" onclick="showDeltaDetail('winRate')">
            <div class="delta-card-header">
              <h4>勝率 Δ（pp）</h4>
              <div class="help-icon" onclick="showHelp('wr'); event.stopPropagation(); return false;">?</div>
            </div>
            <div class="delta-value ${cls(x.winRate)}">${sign(x.winRate)}${Math.abs(x.winRate).toFixed(1)}pp</div>
            <div class="sparkline-container"><div id="sparkline-wr"></div></div>
          </div>
        </div>
      </div>`;

    const POS = csVar('--positive-color', '#00c8ff');
    const NEG = csVar('--negative-color', '#ff3200');
    const NEU = csVar('--neutral-color',  '#6b7280');
    drawSparkline('sparkline-pf', generateSparklineData(x.profitFactor),  x.profitFactor>0?POS:x.profitFactor<0?NEG:NEU);
    drawSparkline('sparkline-ev', generateSparklineData(x.expectedValue/1000), x.expectedValue>0?POS:x.expectedValue<0?NEG:NEU);
    drawSparkline('sparkline-wr', generateSparklineData(x.winRate),           x.winRate>0?POS:x.winRate<0?NEG:NEU);
  }

document.getElementById('detailsSection').innerHTML = `
  <div class="stats-section">
    <h3 class="section-title">勝ち負け詳細分布</h3>
    <div class="stats-grid">

      <div class="stats-card">
        <h4 class="positive" style="margin-bottom:10px">勝ちトレード統計</h4>
        <div class="stats-row"><span>取引回数</span><b>${win}回</b></div>
        <div class="stats-row"><span>総利益額</span><b class="positive">${Math.round(win*d.kpi.avgProfit).toLocaleString()}円</b></div>
        <div class="stats-row"><span>平均利益</span><b>${Math.round(d.kpi.avgProfit).toLocaleString()}円</b></div>
        <div class="stats-row"><span>最大利益</span><b class="positive">${d.pareto.top[0].toLocaleString()}円</b></div>
        <div class="stats-row"><span>最小利益</span><b>${d.pareto.top[4].toLocaleString()}円</b></div>
      </div>

      <div class="stats-card">
        <h4 class="negative" style="margin-bottom:10px">負けトレード統計</h4>
        <div class="stats-row"><span>取引回数</span><b>${lose}回</b></div>
        <div class="stats-row"><span>総損失額</span><b class="negative">${Math.round(Math.abs(lose*d.kpi.avgLoss)).toLocaleString()}円</b></div>
        <div class="stats-row"><span>平均損失</span><b>${Math.round(Math.abs(d.kpi.avgLoss)).toLocaleString()}円</b></div>
        <div class="stats-row"><span>最大損失</span><b class="negative">${Math.abs(d.pareto.bottom[0]).toLocaleString()}円</b></div>
        <div class="stats-row"><span>最小損失</span><b>${Math.abs(d.pareto.bottom[4]).toLocaleString()}円</b></div>
      </div>

    </div>
  </div>`;

  document.getElementById('chartsSection').innerHTML = `
    <div class="chart-container"><h3 class="section-title">累積収益推移</h3><div class="chart-canvas-container"><canvas id="profitChart"></canvas></div></div>
    <div class="chart-container"><h3 class="section-title">収益分布ヒストグラム</h3><div class="chart-canvas-container"><canvas id="distributionChart"></canvas></div></div>`;

createProfitChart(d);
createDistributionChart(d);
// 数字と単位の見た目を整える
if (window.enhanceNumericTypography) enhanceNumericTypography();
}

function createProfitChart(d){
  const ctx=document.getElementById('profitChart').getContext('2d');
  const POS = csVar('--positive-color', '#00c8ff');
  const GRID= csVar('--chart-grid-color', 'rgba(255,255,255,.2)');
  const TXT = csVar('--chart-text-color', '#aaa');
  const chart=new Chart(ctx,{type:'line',
    data:{labels:d.charts.cumulative.map((_,i)=>i+1),
          datasets:[{label:'累積収益',data:d.charts.cumulative,borderColor:POS,backgroundColor:POS+'20',tension:.1,pointRadius:0,borderWidth:2}]},
    options:{responsive:true,maintainAspectRatio:true,aspectRatio:2.5,plugins:{legend:{display:false}},
      scales:{x:{title:{display:true,text:'取引番号',color:TXT},ticks:{color:TXT,maxTicksLimit:10},grid:{color:GRID}},
              y:{title:{display:true,text:'累積収益（円）',color:TXT},ticks:{color:TXT,callback:v=>v.toLocaleString()+'円'},grid:{color:GRID}}}}
  });
  activeCharts.push(chart);
}

function createDistributionChart(d){
  const ctx=document.getElementById('distributionChart').getContext('2d');
  const POS = csVar('--positive-color', '#00c8ff');
  const NEG = csVar('--negative-color', '#ff3200');
  const NEU = csVar('--neutral-color',  '#6b7280');
  const GRID= csVar('--chart-grid-color', 'rgba(255,255,255,.2)');
  const TXT = csVar('--chart-text-color', '#aaa');

  const toRGBA = (hex, a) => {
    const h = hex.replace('#','');
    const r = parseInt(h.slice(0,2),16),
          g = parseInt(h.slice(2,4),16),
          b = parseInt(h.slice(4,6),16);
    return `rgba(${r},${g},${b},${a})`;
  };

  const dist=d.charts.distribution;
  const chart=new Chart(ctx,{type:'bar',
    data:{labels:dist.map(x=>x.range),
      datasets:[{label:'取引回数',data:dist.map(x=>x.count),
        /* ここを少し明るく（不透明度UP） */
        backgroundColor:dist.map(x=>({
          positive: toRGBA(POS,0.90),
          negative: toRGBA(NEG,0.90),
          neutral : toRGBA(NEU,0.88)
        }[x.color])),
        borderColor:dist.map(x=>({
          positive: toRGBA(POS,1),
          negative: toRGBA(NEG,1),
          neutral : toRGBA(NEU,1)
        }[x.color])),
        borderWidth:1
      }]},
    options:{responsive:true,maintainAspectRatio:true,aspectRatio:2.5,plugins:{legend:{display:false}},
      scales:{x:{title:{display:true,text:'収益範囲',color:TXT},ticks:{autoSkip:false,maxRotation:45,minRotation:45,color:TXT,font:{size:10}},grid:{color:GRID}},
              y:{title:{display:true,text:'取引回数',color:TXT},beginAtZero:true,ticks:{stepSize:1,color:TXT},grid:{color:GRID}}}}
  });
  activeCharts.push(chart);
}

function enhanceNumericTypography(){
  const targets = document.querySelectorAll('.metric-value, .delta-value, #detailsSection b');

  targets.forEach(el=>{
    if(el.querySelector('.num')) return;
    const t = (el.textContent || '').trim();
    if(!t) return;

    // ① 「3時間45分」を “3”“45” に分解して強調
    const time = t.match(/^\s*(\d+)\s*時間\s*(\d+)\s*分\s*$/);
    if (time) {
      el.innerHTML =
        `<span class="num">${time[1]}</span><span class="unit">時間</span>`+
        `<span class="num">${time[2]}</span><span class="unit">分</span>`;
      return;
    }

    // ② 通常の数値（通貨記号/符号も許容）
    const m = t.match(/^\s*(?:[¥$€]\s*)?([+\-−]?\d{1,3}(?:,\d{3})*(?:\.\d+)?|[+\-−]?\d+(?:\.\d+)?)(.*)$/);
    if(!m) return;

    const value = (m[1] || '').replace('−','-');
    const unit  = (m[2] || '').trim();

    el.innerHTML =
      `<span class="num">${value}</span>` +
      (unit ? `<span class="unit">${unit}</span>` : '');
  });
}

/* ===== 起動 & ヘッダー連携 ===== */
window.addEventListener('DOMContentLoaded', ()=>{
  // ダミーの累積生成
  dataSets.excellent.charts.cumulative = generateRealisticCumulativeCurve(150, 320000, 0.752);
  dataSets.average.charts.cumulative   = generateRealisticCumulativeCurve(120,  45000, 0.558);
  dataSets.poor.charts.cumulative      = generateRealisticCumulativeCurve(95,  -85000, 0.389);

  currentData = dataSets.average;
  renderAnalysis();
});

document.addEventListener('filtersChanged', ()=>{ if(currentData) renderAnalysis(); });
document.addEventListener('demoChanged', (e)=>{
  const key = (e.detail && e.detail.trader) || 'average';
  currentData = dataSets[key] || dataSets.average;
  renderAnalysis();
});
document.addEventListener('tabChanged', (e)=>{
  const root = document.getElementById('overviewRoot');
  if(!root) return;
  if(e.detail && e.detail.section === 'overview'){
    renderAnalysis();
  }else{
    root.innerHTML = `<div style="padding:24px;color:var(--text-sub, #aaa)">「${e.detail?.section||''}」は準備中です。</div>`;
  }
});

document.addEventListener('themeChanged', ()=>{ if(currentData) renderAnalysis(); });
new MutationObserver(()=>{ if(currentData) renderAnalysis(); })
  .observe(document.documentElement, { attributes:true, attributeFilter:['class'] });

</script>


<script>
function showHelp(type){
  const msg = {
    totalTrades:'総取引数

分析対象となる取引の総数です。

統計的信頼性のためには最低でも30回以上の取引が推奨されます。',
    winRate:'勝率

全取引のうち利益を上げた取引の割合です。

• 50%以上：標準的
• 60%以上：優良
• 70%以上：優秀',
    totalProfit:'総収益

すべての取引の損益を合計した金額です。

取引戦略の最終的な成果を示します。',
    avgProfit:'平均利益

勝ちトレードの平均利益額です。

損切りラインとの比較でリスクリワード比を評価できます。',
    avgLoss:'平均損失

負けトレードの平均損失額です。

リスク管理の指標として重要です。',
    avgHoldingTime:'平均保有時間

ポジション開始から決済までの平均時間です。

• 短時間：スキャルピング
• 数時間：デイトレード
• 数日～：スイングトレード',
    expectedValue:'期待値

1取引あたりの理論的期待収益です。

正の値は長期的な利益を示唆します。',
    profitFactor:'プロフィットファクター

総利益 ÷ 総損失の比率です。

1.0以上で利益が損失を上回ります。',
    pf:'プロフィットファクター（PF）

総利益 ÷ 総損失で計算される指標です。

• 1.0以上：利益が損失を上回る
• 1.0未満：損失が利益を上回る
• 2.0以上：優秀なトレーダー

Δ（デルタ）は前期からの変化量を表します。',
    ev:'期待値（EV）

1取引あたりの平均収益を表します。

計算式：（勝率 × 平均利益）-（負率 × 平均損失）

Δ（デルタ）は前期からの変化量を表します。',
    wr:'勝率変化（pp）

勝率の変化をパーセントポイント（pp）で表示します。'
  };
  alert(msg[type]||'ヘルプ情報が見つかりません');
}
</script>

</body>
</html>
